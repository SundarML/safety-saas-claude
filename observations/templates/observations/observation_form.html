{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block content %}
<div class="card">
  <div class="card-body">
    <h3 class="card-title mb-3">
      {% if form.instance.pk %}Update / Rectify Observation{% else %}New Observation{% endif %}
    </h3>

    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}

      <!-- LOCATION FIELD WITH ADD BUTTON -->
      <div class="mb-3">
        <!-- <label for="id_location" class="form-label">Location</label> -->

        <div class="input-group">
          {{ form.location|as_crispy_field }}
          <!-- <button type="button" class="btn btn-link p-0 text-primary"
                data-bs-toggle="modal" data-bs-target="#addLocationModal"
                style="text-decoration: none; font-weight: 600;">
            + Add
          </button> -->
          <button type="button"
                  class="btn p-1"
                  style="background: transparent; color: #0d6efd; border: none;"
                  data-bs-toggle="modal" data-bs-target="#addLocationModal">
              + Add
          </button>
          <!-- <button type="button" class="btn btn-link p-0 text-primary"
                  data-bs-toggle="modal" data-bs-target="#addLocationModal"
                  style="text-decoration: none; font-weight: 600;">
              + Add
          </button> -->



        </div>
      </div>

      <!-- Render remaining fields -->
      {% for field in form %}
        {% if field.name not in "location photo_before photo_after" %}
          {{ field|as_crispy_field }}
        {% endif %}
      {% endfor %}
      <!-- PHOTO BEFORE FIELD -->
      {% if form.photo_before %}
        <div class="mb-3">
          <label class="form-label">Photo Before</label>

          {% if form.instance.photo_before %}
            <div class="mb-2">
              <img src="{{ form.instance.photo_before.url }}"
                  class="img-thumbnail"
                  style="max-width:150px; cursor: zoom-in;"
                  data-bs-toggle="modal"
                  data-bs-target="#beforeImageModal"
                  alt="Before Image">
            </div>
          {% endif %}

          {{ form.photo_before }}
        </div>
      {% endif %}
      <!-- PHOTO AFTER FIELD -->
      {% if form.photo_after %}
        <div class="mb-3">
          <label class="form-label">Photo After</label>

          {% if form.instance.photo_after %}
            <div class="mb-2">
              <img src="{{ form.instance.photo_after.url }}"
                  class="img-thumbnail"
                  style="max-width:150px; cursor: zoom-in;"
                  data-bs-toggle="modal"
                  data-bs-target="#afterImageModal"
                  alt="After Image">
            </div>
          {% endif %}

          {{ form.photo_after }}
        </div>
      {% endif %}


      <div class="mt-3">
        <button class="btn btn-primary" type="submit">Submit</button>
        <a class="btn btn-secondary" href="{% url 'observations:observation_list' %}">Cancel</a>
      </div>
    </form>
  </div>
</div>

<!-- BEFORE IMAGE MODAL -->
{% if form.instance.photo_before %}
<div class="modal fade" id="beforeImageModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Before Image</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <img src="{{ form.instance.photo_before.url }}" class="img-fluid rounded">
      </div>
    </div>
  </div>
</div>
{% endif %}
<!-- AFTER IMAGE MODAL -->
{% if form.instance.photo_after %}
<div class="modal fade" id="afterImageModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">After Image</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <img src="{{ form.instance.photo_after.url }}" class="img-fluid rounded">
      </div>
    </div>
  </div>
</div>
{% endif %}



<!-- ADD LOCATION MODAL -->
<div class="modal fade" id="addLocationModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Add New Location</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <form id="addLocationForm">
          {% csrf_token %}

          <div class="mb-3">
            <label class="form-label">Location Name</label>
            <input name="name" type="text" class="form-control" required>
          </div>

          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea name="description" class="form-control" rows="3"></textarea>
          </div>

        </form>

        <div id="locationErrors" class="text-danger small"></div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="saveLocationBtn">Save</button>
      </div>

    </div>
  </div>
</div>

<!-- AJAX SCRIPT (ONLY ONCE) -->
<script>
document.getElementById("saveLocationBtn").addEventListener("click", function () {

    let form = document.getElementById("addLocationForm");
    let formData = new FormData(form);

    fetch("{% url 'observations:ajax_add_location' %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": formData.get("csrfmiddlewaretoken")
        },
        body: formData
    })
    .then(res => res.json())
    .then(data => {

        if (data.success) {

            // add new option
            let select = document.getElementById("id_location");
            let option = document.createElement("option");
            option.value = data.id;
            option.text = data.name;
            option.selected = true;
            select.appendChild(option);

            // close modal
            let modal = bootstrap.Modal.getInstance(document.getElementById("addLocationModal"));
            modal.hide();

            // reset form
            form.reset();
            document.getElementById("locationErrors").innerHTML = "";

        } else {
            // print errors
            let errorBox = document.getElementById("locationErrors");
            errorBox.innerHTML = "";
            for (let field in data.errors) {
                errorBox.innerHTML += `${field}: ${data.errors[field][0]}<br>`;
            }
        }
    });
});
</script>

{% endblock %}
