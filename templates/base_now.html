<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}Vigilo{% endblock %}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <style>
    body { 
      background: #f8f9fa; 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    /* â”€â”€â”€ Sidebar (Dark) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #sidebar {
      width: 260px;
      min-height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      background: #1a1d29;
      color: #a0a4b8;
      transition: transform .3s ease;
      z-index: 1040;
      overflow-y: auto;
      padding-bottom: 20px;
    }
    #sidebar.collapsed { transform: translateX(-100%); }
    
    .sidebar-brand {
      padding: 18px 20px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display: flex;
      align-items: center;
      gap: 10px;
      color: white;
      font-weight: 700;
      font-size: 1.1rem;
    }

    .sidebar-section {
      padding: 20px 0 8px 20px;
      font-size: .72rem;
      font-weight: 700;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: #6b7280;
    }

    .sidebar-link {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 9px 20px;
      color: #a0a4b8;
      text-decoration: none;
      font-size: .9rem;
      font-weight: 500;
      transition: all .15s;
      border-left: 3px solid transparent;
    }
    .sidebar-link:hover {
      background: rgba(255,255,255,.05);
      color: white;
    }
    .sidebar-link.active {
      background: rgba(99,102,241,.12);
      color: white;
      border-left-color: #6366f1;
    }
    .sidebar-link i {
      font-size: 1.05rem;
      width: 20px;
      text-align: center;
    }

    .sidebar-divider {
      height: 1px;
      background: rgba(255,255,255,.08);
      margin: 12px 0;
    }

    .sidebar-badge {
      margin-left: auto;
      font-size: .68rem;
      padding: 2px 7px;
      border-radius: 10px;
      font-weight: 700;
    }
    .sidebar-badge.trial {
      background: rgba(245,158,11,.2);
      color: #fbbf24;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50%      { opacity: .6; }
    }

    /* â”€â”€â”€ Top Bar (Light) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #topbar {
      position: fixed;
      top: 0;
      left: 260px;
      right: 0;
      height: 60px;
      background: white;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      padding: 0 24px;
      z-index: 1030;
      transition: left .3s ease;
    }
    #topbar.sidebar-collapsed { left: 0; }

    #topbar .org-name {
      font-weight: 600;
      font-size: .95rem;
      color: #1f2937;
    }
    #topbar .user-menu {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: .8rem;
    }
    .topbar-btn {
      background: transparent;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 6px 12px;
      font-size: .85rem;
      color: #6b7280;
      cursor: pointer;
      transition: all .15s;
    }
    .topbar-btn:hover {
      background: #f9fafb;
      border-color: #d1d5db;
    }

    /* â”€â”€â”€ Main Content Area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #content {
      margin-left: 260px;
      margin-top: 60px;
      padding: 24px;
      transition: margin-left .3s ease;
      min-height: calc(100vh - 60px);
    }
    #content.sidebar-collapsed { margin-left: 0; }

    /* â”€â”€â”€ Mobile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width: 768px) {
      #sidebar { transform: translateX(-100%); }
      #sidebar.show { transform: translateX(0); }
      #topbar { left: 0; }
      #content { margin-left: 0; margin-top: 60px; }
    }

    /* â”€â”€â”€ Dropdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .dropdown-menu {
      border: 1px solid #e5e7eb;
      box-shadow: 0 4px 20px rgba(0,0,0,.08);
      border-radius: 8px;
      padding: 8px;
    }
    .dropdown-item {
      border-radius: 4px;
      padding: 8px 12px;
      font-size: .88rem;
    }
    .dropdown-item:hover { background: #f3f4f6; }
    .dropdown-divider { margin: 8px 0; border-color: #e5e7eb; }
  </style>
  {% block extra_head %}{% endblock %}
</head>

<body>

<!-- Help Modal -->
<div class="modal fade" id="helpModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ðŸ“˜ Vigilo â€” Help</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <h6>Observation Workflow</h6>
        <ol class="small">
          <li>Observe â†’ Report hazard</li>
          <li>Assign â†’ Set owner + deadline</li>
          <li>Rectify â†’ Fix + photo evidence</li>
          <li>Verify â†’ Safety Manager approves</li>
          <li>Archive â†’ Permanent record</li>
        </ol>
      </div>
    </div>
  </div>
</div>

{% if user.is_authenticated %}
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     AUTHENTICATED LAYOUT: Sidebar + Topbar + Content
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- SIDEBAR -->
<div id="sidebar">
  <div class="sidebar-brand"><span>ðŸ¦º</span><span>Vigilo</span></div>

  {% if not user.is_contractor %}
  <div class="sidebar-section">Observations</div>
  <a href="{% url 'observations:dashboard' %}" class="sidebar-link {% if 'observations' in request.path and 'dashboard' in request.path %}active{% endif %}">
    <i class="bi bi-bar-chart-line"></i><span>Dashboard</span>
  </a>
  <a href="{% url 'observations:observation_list' %}" class="sidebar-link {% if 'observations' in request.path and 'dashboard' not in request.path and 'new' not in request.path and 'archived' not in request.path %}active{% endif %}">
    <i class="bi bi-list-ul"></i><span>All Observations</span>
  </a>
  <a href="{% url 'observations:create' %}" class="sidebar-link {% if 'observations' in request.path and 'new' in request.path %}active{% endif %}">
    <i class="bi bi-plus-circle"></i><span>Report New</span>
  </a>
  <a href="{% url 'observations:archived_list' %}" class="sidebar-link {% if 'archived' in request.path %}active{% endif %}">
    <i class="bi bi-archive"></i><span>Archived</span>
  </a>
  {% if user.is_manager or user.is_safety_manager %}
  <a href="{% url 'observations:export_observations_csv' %}" class="sidebar-link">
    <i class="bi bi-download"></i><span>Export CSV</span>
  </a>
  {% endif %}
  <div class="sidebar-divider"></div>
  {% endif %}

  <div class="sidebar-section">Permit to Work</div>
  <a href="{% url 'permits:dashboard' %}" class="sidebar-link {% if 'permits' in request.path and 'dashboard' in request.path %}active{% endif %}">
    <i class="bi bi-bar-chart-line"></i><span>PTW Dashboard</span>
  </a>
  <a href="{% url 'permits:permit_list' %}" class="sidebar-link {% if 'permits' in request.path and 'dashboard' not in request.path and 'new' not in request.path %}active{% endif %}">
    <i class="bi bi-file-earmark-check"></i><span>All Permits</span>
  </a>
  <a href="{% url 'permits:create' %}" class="sidebar-link {% if 'permits' in request.path and 'new' in request.path %}active{% endif %}">
    <i class="bi bi-plus-circle"></i><span>New Permit</span>
  </a>

  {% if not user.is_contractor %}
  <div class="sidebar-divider"></div>
  <div class="sidebar-section">Administration</div>
  {% if user.is_manager %}
  <a href="{% url 'core:invite_user' %}" class="sidebar-link {% if 'invite' in request.path and 'contractor' not in request.path %}active{% endif %}">
    <i class="bi bi-person-plus"></i><span>Invite Staff</span>
  </a>
  <a href="{% url 'core:invite_contractor' %}" class="sidebar-link {% if 'invite-contractor' in request.path %}active{% endif %}">
    <i class="bi bi-person-badge"></i><span>Invite Contractor</span>
  </a>
  <a href="{% url 'core:billing' %}" class="sidebar-link {% if 'billing' in request.path %}active{% endif %}">
    <i class="bi bi-credit-card"></i><span>Billing</span>
  </a>
  {% endif %}
  <div class="sidebar-divider"></div>
  <button class="sidebar-link text-start w-100" style="background:none;border:none;" data-bs-toggle="modal" data-bs-target="#helpModal">
    <i class="bi bi-question-circle"></i><span>Help</span>
  </button>
  {% endif %}
</div>

<!-- TOPBAR -->
<div id="topbar">
  <button class="topbar-btn d-md-none me-3" id="sidebarToggle"><i class="bi bi-list"></i></button>
  {% if current_org %}<div class="org-name">{{ current_org.name }}</div>{% endif %}
  <div class="user-menu">
    <div class="dropdown">
      <button class="btn btn-link text-decoration-none p-0" data-bs-toggle="dropdown" style="border:none;">
        <div class="d-flex align-items-center gap-2">
          <div class="user-avatar">{{ user.get_short_name|slice:":1"|upper }}</div>
          <div class="d-none d-md-block text-start">
            <div style="font-size:.85rem;font-weight:600;color:#1f2937;">{{ user.get_full_name }}</div>
            <div style="font-size:.72rem;color:#9ca3af;">{{ user.email }}</div>
          </div>
          <i class="bi bi-chevron-down d-none d-md-inline" style="font-size:.7rem;color:#9ca3af;"></i>
        </div>
      </button>
      <ul class="dropdown-menu dropdown-menu-end">
        <li><a class="dropdown-item" href="{% url 'users:profile' %}"><i class="bi bi-person me-2"></i>Profile</a></li>
        {% if user.is_manager %}
        <li><a class="dropdown-item" href="{% url 'core:billing' %}"><i class="bi bi-credit-card me-2"></i>Billing</a></li>
        {% endif %}
        <li><hr class="dropdown-divider"></li>
        <li>
          <form method="post" action="{% url 'users:logout' %}" style="margin:0;">
            {% csrf_token %}
            <button type="submit" class="dropdown-item text-danger" style="border:none;background:none;width:100%;text-align:left;cursor:pointer;">
              <i class="bi bi-box-arrow-right me-2"></i>Logout
            </button>
          </form>
        </li>
      </ul>
    </div>
  </div>
</div>

<!-- CONTENT WRAPPER -->
<div id="content">
  {% if messages %}
  <div class="mb-3">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
      {{ message }}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %}
  </div>
  {% endif %}
  
  <!-- Content from child templates renders here -->
</div>

{% else %}
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     UNAUTHENTICATED LAYOUT: Full-width, no sidebar
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
{% if messages %}
<div class="container mt-3">
  {% for message in messages %}
  <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
    {{ message }}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
  {% endfor %}
</div>
{% endif %}

<!-- Content from child templates renders here -->

{% endif %}

<!-- SINGLE CONTENT BLOCK FOR BOTH AUTHENTICATED AND UNAUTHENTICATED -->
{% block content %}{% endblock %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.getElementById('sidebarToggle')?.addEventListener('click', function() {
  document.getElementById('sidebar').classList.toggle('show');
  document.getElementById('sidebar').classList.toggle('collapsed');
  document.getElementById('topbar').classList.toggle('sidebar-collapsed');
  document.getElementById('content').classList.toggle('sidebar-collapsed');
});
</script>
{% block extra_js %}{% endblock %}
</body>
</html>
