{% extends "base.html" %}
{% block title %}Permits to Work{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2><i class="bi bi-file-earmark-check me-2"></i>Permits to Work</h2>
  <div class="d-flex gap-2">
    <a href="{% url 'permits:dashboard' %}" class="btn btn-outline-primary btn-sm">
      <i class="bi bi-bar-chart me-1"></i>Dashboard
    </a>
    <a href="{% url 'permits:create' %}" class="btn btn-success btn-sm">
      <i class="bi bi-plus-circle me-1"></i>New Permit
    </a>
  </div>
</div>

<!-- Filters -->
<form method="get" class="row g-2 mb-3">
  <div class="col-md-4">
    <input type="text" name="q" value="{{ q }}" class="form-control form-control-sm"
           placeholder="Search permit no., title, contractorâ€¦">
  </div>
  <div class="col-md-2">
    <select name="status" class="form-select form-select-sm">
      <option value="">All Statuses</option>
      {% for val, label in status_choices %}
      <option value="{{ val }}" {% if status_f == val %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-3">
    <select name="work_type" class="form-select form-select-sm">
      <option value="">All Work Types</option>
      {% for val, label in type_choices %}
      <option value="{{ val }}" {% if type_f == val %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-2">
    <button class="btn btn-primary btn-sm w-100">Filter</button>
  </div>
  <div class="col-md-1">
    <a href="{% url 'permits:permit_list' %}" class="btn btn-outline-secondary btn-sm w-100">Clear</a>
  </div>
</form>

<div class="table-responsive">
  <table class="table table-bordered table-hover align-middle">
    <thead class="table-dark">
      <tr>
        <th>Permit No.</th>
        <th>Work Type</th>
        <th>Title</th>
        <th>Location</th>
        <th>Requestor</th>
        <th>Planned Start</th>
        <th>Planned End</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for permit in permits %}
      <tr class="{% if permit.is_overdue %}table-danger{% endif %}">
        <td><a href="{% url 'permits:detail' permit.pk %}">{{ permit.permit_number }}</a></td>
        <td>
          <span class="badge bg-secondary">{{ permit.get_work_type_display }}</span>
        </td>
        <td>{{ permit.title }}</td>
        <td>{{ permit.location }}</td>
        <td>{{ permit.requestor.get_full_name }}</td>
        <td>{{ permit.planned_start|date:"d M Y H:i" }}</td>
        <td>{{ permit.planned_end|date:"d M Y H:i" }}</td>
        <td>
          {% if permit.status == "DRAFT" %}
            <span class="badge bg-secondary">Draft</span>
          {% elif permit.status == "SUBMITTED" %}
            <span class="badge bg-warning text-dark">Submitted</span>
          {% elif permit.status == "APPROVED" %}
            <span class="badge bg-info text-dark">Approved</span>
          {% elif permit.status == "ACTIVE" %}
            <span class="badge bg-success">Active</span>
          {% elif permit.status == "CLOSED" %}
            <span class="badge bg-dark">Closed</span>
          {% elif permit.status == "REJECTED" %}
            <span class="badge bg-danger">Rejected</span>
          {% elif permit.status == "CANCELLED" %}
            <span class="badge bg-light text-dark border">Cancelled</span>
          {% endif %}
          {% if permit.is_overdue %}
            <span class="badge bg-danger ms-1">Overdue</span>
          {% endif %}
        </td>
        <td>
          <a href="{% url 'permits:detail' permit.pk %}" class="btn btn-sm btn-outline-primary" title="View">
            <i class="bi bi-eye"></i>
          </a>
          {% if permit.status == "DRAFT" and permit.requestor == request.user %}
          <a href="{% url 'permits:edit' permit.pk %}" class="btn btn-sm btn-outline-secondary" title="Edit">
            <i class="bi bi-pencil"></i>
          </a>
          {% endif %}
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="9" class="text-center text-muted py-4">No permits found.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Pagination -->
<nav>
  <ul class="pagination pagination-sm justify-content-center">
    {% if page_obj.has_previous %}
    <li class="page-item">
      <a class="page-link" href="?q={{ q }}&status={{ status_f }}&work_type={{ type_f }}&page=1">First</a>
    </li>
    <li class="page-item">
      <a class="page-link" href="?q={{ q }}&status={{ status_f }}&work_type={{ type_f }}&page={{ page_obj.previous_page_number }}">Prev</a>
    </li>
    {% endif %}
    <li class="page-item active">
      <span class="page-link">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
    </li>
    {% if page_obj.has_next %}
    <li class="page-item">
      <a class="page-link" href="?q={{ q }}&status={{ status_f }}&work_type={{ type_f }}&page={{ page_obj.next_page_number }}">Next</a>
    </li>
    <li class="page-item">
      <a class="page-link" href="?q={{ q }}&status={{ status_f }}&work_type={{ type_f }}&page={{ page_obj.paginator.num_pages }}">Last</a>
    </li>
    {% endif %}
  </ul>
</nav>
{% endblock %}
