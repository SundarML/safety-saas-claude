{% extends "base.html" %}
{% load crispy_forms_tags %}
{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-9">

    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3><i class="bi bi-file-earmark-plus me-2"></i>{{ title }}</h3>
      <a href="{% url 'permits:permit_list' %}" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-left me-1"></i>Back
      </a>
    </div>

    {% if form.errors %}
    <div class="alert alert-danger">
      <strong>Please fix the following errors:</strong>
      <ul class="mb-0 mt-2">
        {% for field in form %}
          {% for error in field.errors %}
            <li><strong>{{ field.label }}:</strong> {{ error }}</li>
          {% endfor %}
        {% endfor %}
        {% for error in form.non_field_errors %}
          <li>{{ error }}</li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data" novalidate>
      {% csrf_token %}

      <!-- Section 1: Work Info -->
      <div class="card mb-4 shadow-sm">
        <div class="card-header bg-dark text-white fw-semibold">
          <i class="bi bi-info-circle me-2"></i>1. Work Information
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">{{ form.work_type|as_crispy_field }}</div>
            <div class="col-md-6">{{ form.title|as_crispy_field }}</div>
            <div class="col-12">{{ form.description|as_crispy_field }}</div>
            <div class="col-md-6">{{ form.location|as_crispy_field }}</div>
            <div class="col-md-6">{{ form.work_area|as_crispy_field }}</div>
          </div>
        </div>
      </div>

      <!-- Section 2: Personnel -->
      <div class="card mb-4 shadow-sm">
        <div class="card-header bg-dark text-white fw-semibold">
          <i class="bi bi-people me-2"></i>2. Personnel
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-5">{{ form.contractor_name|as_crispy_field }}</div>
            <div class="col-md-4">{{ form.contractor_contact|as_crispy_field }}</div>
            <div class="col-md-3">{{ form.workers_count|as_crispy_field }}</div>
          </div>
        </div>
      </div>

      <!-- Section 3: Schedule -->
      <div class="card mb-4 shadow-sm">
        <div class="card-header bg-dark text-white fw-semibold">
          <i class="bi bi-calendar-range me-2"></i>3. Schedule
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">{{ form.planned_start|as_crispy_field }}</div>
            <div class="col-md-6">{{ form.planned_end|as_crispy_field }}</div>
          </div>
        </div>
      </div>

      <!-- Section 4: Hazards & Controls -->
      <div class="card mb-4 shadow-sm">
        <div class="card-header bg-warning text-dark fw-semibold">
          <i class="bi bi-exclamation-triangle me-2"></i>4. Hazard Identification & Controls
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-12">{{ form.hazards_identified|as_crispy_field }}</div>
            <div class="col-12">{{ form.risk_controls|as_crispy_field }}</div>
            <div class="col-12">{{ form.ppe_required|as_crispy_field }}</div>
            <div class="col-md-4">{{ form.isolation_required|as_crispy_field }}</div>
            <div class="col-md-8" id="isolation-detail-field">
              {{ form.isolation_details|as_crispy_field }}
            </div>
            <div class="col-12">{{ form.emergency_procedure|as_crispy_field }}</div>
          </div>
        </div>
      </div>

      <!-- Section 5: Pre-work Checklist -->
      <div class="card mb-4 shadow-sm">
        <div class="card-header bg-info text-dark fw-semibold">
          <i class="bi bi-check2-square me-2"></i>5. Pre-work Checklist
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">{{ form.toolbox_talk_done|as_crispy_field }}</div>
            <div class="col-md-6">{{ form.area_barricaded|as_crispy_field }}</div>
            <div class="col-md-6">{{ form.equipment_inspected|as_crispy_field }}</div>
            <div class="col-md-6">{{ form.gas_test_done|as_crispy_field }}</div>
            <div class="col-md-6" id="gas-result-field">
              {{ form.gas_test_result|as_crispy_field }}
            </div>
          </div>
        </div>
      </div>

      <!-- Section 6: Attachment -->
      <div class="card mb-4 shadow-sm">
        <div class="card-header bg-dark text-white fw-semibold">
          <i class="bi bi-paperclip me-2"></i>6. Attachment (optional)
        </div>
        <div class="card-body">
          {{ form.attachment|as_crispy_field }}
          {% if permit.attachment %}
          <p class="mt-1 small text-muted">
            Current: <a href="{{ permit.attachment.url }}" target="_blank">{{ permit.attachment.name }}</a>
          </p>
          {% endif %}
        </div>
      </div>

      <div class="d-flex gap-2 mb-5">
        <button type="submit" class="btn btn-primary px-5">
          <i class="bi bi-save me-1"></i>Save as Draft
        </button>
        <a href="{% url 'permits:permit_list' %}" class="btn btn-outline-secondary">Cancel</a>
      </div>

    </form>
  </div>
</div>

<script>
  // Toggle isolation detail
  const isoCheck = document.getElementById("id_isolation_required");
  const isoField = document.getElementById("isolation-detail-field");
  function toggleIso() {
    isoField.style.display = isoCheck && isoCheck.checked ? "" : "none";
  }
  if (isoCheck) { isoCheck.addEventListener("change", toggleIso); toggleIso(); }

  // Toggle gas test result
  const gasCheck  = document.getElementById("id_gas_test_done");
  const gasResult = document.getElementById("gas-result-field");
  function toggleGas() {
    gasResult.style.display = gasCheck && gasCheck.checked ? "" : "none";
  }
  if (gasCheck) { gasCheck.addEventListener("change", toggleGas); toggleGas(); }
</script>
{% endblock %}
